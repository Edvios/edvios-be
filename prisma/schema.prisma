generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model Test {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tests")
}

model User {
  id        String     @id
  firstName String?
  lastName  String?
  email     String     @unique
  role      UserRole   @default(STUDENT)
  status    UserStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  phone     String?
  agent     Agent?
  student   Student?
emailVerified             Boolean    @default(false)
  verificationToken         String?    @unique
  verificationTokenExpires  DateTime?
  documents Document[]

  documents Document[]

  documents Document[]

  @@map("users")
}

model Student {
  id                         String   @id

  firstName                String?
  lastName                 String?
  dob                      DateTime?
  gender                     Gender?
  nationality                String
  passportNumber             String   @unique
  passportExpiryDate         DateTime
  countryOfResidence         String

  email                      String
  phone               	     String
  emergencyContact           String // Name + number combined (or split later)

  highestQualification       String
  yearOfCompletion           Int?
  institutionName            String
  mediumOfInstruction        String?
  gradesSummary              String?
  academicCertificates       String[] // file refs / URLs

  englishTestTaken           EnglishTestType @default(NONE)
  overallScore               Float?
  testExpiryDate             DateTime?

  intendedIntakeMonth        Int?   // 1â€“12
  intendedIntakeYear         Int?
  preferredCountries         String[]
  preferredStudyLevel        StudyLevel?
  preferredFieldOfStudy      String

  estimatedBudget            Float? // tuition + living
  fundingSource              FundingSource?

  previousVisaRefusal        Boolean @default(false)
  visaRefusalDetails         String?
  travelHistory              String?
  ongoingImmigrationApps     String?

  academicFit                String?
  visaRiskBand               VisaRiskBand?
  notes                      String?

  applications             Application[]
  agentAssignment          AgentAssignment[]
  user                     User              @relation(fields: [id], references: [id], onDelete: Cascade)

  @@map("students")
}

model Agent {
  id              String            @id

  legalName                         String
  tradingName                       String?
  agentName                         String
  calendlyLink                      String?
  countryOfRegistration             String
  yearEstablished                   Int?
  websiteUrl                        String?
  officeAddress                     String

  contactPersonName                 String
  designation                       String?
  officialEmail                     String
  phoneNumber                       String

  businessRegistrationNumber        String
  businessRegistrationCertificate   String? // file ref / URL
  officeAddressProof                String? // file ref / URL

  registeredWithEducationCouncils   Boolean  @default(false)
  workingWithUkInstitutions         Boolean  @default(false)
  workingWithCanadaInstitutions     Boolean  @default(false)
  workingWithAustraliaInstitutions  Boolean  @default(false)

  primaryStudentMarkets             String[] // e.g. ["Sri Lanka", "India"]
  averageStudentsPerYearLast2Years  Int?
  mainDestinations                  String[] // e.g. ["UK", "Canada"]

  typicalStudentProfileStrength     String?
  inHouseVisaSupport                Boolean  @default(false)
  numberOfCounsellors               Int @default(1)

  servicesProvided                  ServiceType[]
  reasonToUseEdvios                 String?
  interestedFeatures                FeatureType[]

  agentTier                         String @default("BASIC")
  notes                             String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  user            User              @relation(fields: [id], references: [id], onDelete: Cascade)
  agentAssignment AgentAssignment[]

  @@map("agents")
}

model Institution {
  id                    String            @id @default(uuid())
  name                  String
  type                  InstitutionType
  country               String
  city                  String
  ranking               Int
  establishedYear       Int
  totalStudents         Int
  internationalStudents Int
  programsCount         Int
  tuitionRange          String
  status                InstitutionStatus
  partnership           PartnershipType
  contactEmail          String
  website               String
  logo                  String?
  description           String
  specialties           String[]
  accreditations        String[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  programs              Program[]
}

model Program {
  id                  String        @id @default(uuid())
  title               String
  duration            String
  tuitionFee          String
  applicationFee      String
  englishTestScore    String
  scholarship         Boolean
  lastUpdated         DateTime
  applicationDeadline DateTime
  ucasCode            String?
  englishWaiver       Boolean
  popularityRank      Int
  status              ProgramStatus
  institutionId       String
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  intakeId            String?
  subjectId           String?
  level               StudyLevel
  institution         Institution   @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  intake              Intake?       @relation(fields: [intakeId], references: [id], onDelete: Cascade)
  subject             Subject?      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  applications        Application[]

  @@index([institutionId])
}

model Subject {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  programs  Program[]

  @@map("subjects")
}

model Intake {
  id           String        @id @default(uuid())
  name         String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  programs     Program[]
  applications Application[]

  @@map("intakes")
}

model AgentAssignment {
  id        String        @id @default(uuid())
  studentId String
  agentId   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  agent     Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  student   Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, agentId])
  @@map("chats")
}

model ChatMessage {
  id              String          @id @default(uuid())
  chatId          String
  senderId        String
  senderRole      UserRole
  content         String
  status          MessageStatus   @default(SENT)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  attachmentName  String?
  attachmentSize  Int?
  attachmentType  String?
  attachmentUrl   String?
  agentAssignment AgentAssignment @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId])
  @@map("chat_messages")
}

model Application {
  id                String            @id @default(uuid())
  studentId         String
  programId         String
  status            ApplicationStatus @default(SUBMITTED)
  additionalNotes   String?
  preferredIntakeId String?
  academicYear      String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  preferredIntake   Intake?           @relation(fields: [preferredIntakeId], references: [id])
  program           Program           @relation(fields: [programId], references: [id], onDelete: Cascade)
  student           Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([programId])
  @@map("applications")
}

model StudentNotification {
  id        String   @id @default(uuid())
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("student_notifications")
}

model AgentNotification {
  id        String   @id @default(uuid())
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("agent_notifications")
}

model Document {
  id          String   @id @default(uuid())
  userId      String
  name        String
  type        String
  url         String
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("documents")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  AGENT
  STUDENT
  PARTIAL_REGISTER_STUDENT
  PARTIAL_REGISTER_AGENT
  PENDING_AGENT
  REJECTED_AGENT
  SELECTED_AGENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum StudyLevel {
  BACHELORS
  MASTERS
  PHD
  DIPLOMA
  CERTIFICATE
}

enum InstitutionType {
  UNIVERSITY
  COLLEGE
  SCHOOL
  INSTITUTE
}

enum InstitutionStatus {
  ACTIVE
  PENDING
  INACTIVE
}

enum PartnershipType {
  PREMIUM
  STANDARD
  BASIC
}

enum ProgramStatus {
  AVAILABLE
  DEADLINE_PASSED
  FULL
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EnglishTestType {
  IELTS
  PTE
  DUOLINGO
  NONE
}

enum FundingSource {
  SELF
  PARENTS
  SPONSOR
  LOAN
  SCHOLARSHIP
}

enum VisaRiskBand {
  LOW
  MEDIUM
  HIGH
}

enum ServiceType {
  ADMISSIONS
  VISA
  END_TO_END
}

enum FeatureType {
  AI_MATCHING
  VISA_RISK
  CRM
  ANALYTICS
  DOCUMENT_MANAGEMENT
}