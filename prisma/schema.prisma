// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model Test {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tests")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  AGENT
  STUDENT
  PENDING_AGENT
  REJECTED_AGENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum StudyLevel {
  BACHELORS
  MASTERS
  PHD
  DIPLOMA
  CERTIFICATE
}

enum InstitutionType {
  UNIVERSITY
  COLLEGE
  SCHOOL
  INSTITUTE
}


enum InstitutionStatus {
  ACTIVE
  PENDING
  INACTIVE
}

enum PartnershipType {
  PREMIUM
  STANDARD
  BASIC
}

enum ProgramStatus {
  AVAILABLE
  DEADLINE_PASSED
  FULL
}


model User {
  id            String    @id // Supabase UUID
  firstName     String?
  lastName      String?
  email         String    @unique
  role          UserRole  @default(STUDENT)
  status        UserStatus @default(ACTIVE)
  phone         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  student       Student?
  agent         Agent?

  @@map("users")
}

model Student {
  id                    String    @id
  user                  User      @relation(fields: [id], references: [id], onDelete: Cascade)
  firstName           String?
  lastName            String?
  email               String ?   @unique
  phone               String?
  address             String?

  // Academic & Background
  nationality           String?
  currentEducationLevel String?   
  currentInstitution    String?
  fieldOfStudy          String?   
  gpa                   Float?
  graduationDate        DateTime?

  // Questionnaire Preferences
  preferredDestination  String?   
  preferredProgram      String?   
  preferredStudyLevel   StudyLevel?
  preferredIntake       String?

  // English & Identity
  englishTest           String?   
  englishScore          String?   
  hasValidPassport      Boolean   @default(false)

  // Document Readiness Checklist
  hasAcademicTranscripts   Boolean @default(false)
  hasRecommendationLetters Boolean @default(false)
  hasPersonalStatement     Boolean @default(false)

  // Narrative Details
  workExperience        String?   @db.Text
  extraCurricular       String?   @db.Text
  careerGoals           String?   @db.Text

  // Communication & CRM
  referralSource        String?   
  preferredContactMethod String?
  bestTimeToContact     String?
  additionalQuestions   String?   @db.Text

  dob                  DateTime?
  currentCountry      String?
  currentCity         String?
  budgetRange         String?
  scholarshipInterest Boolean   @default(false)
  marketingConsent    Boolean   @default(false)

  applications         Application[]
  
  createdAt           DateTime  @default(now())

  chats               Chat[]

  @@map("students")
}

model Agent {
  id        String @id
  user      User   @relation(fields: [id], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chats     Chat[]

  @@map("agents")
}

model Institution {
  id                    String            @id @default(uuid())
  name                  String
  type                  InstitutionType
  country               String
  city                  String
  ranking               Int
  establishedYear       Int
  totalStudents         Int
  internationalStudents Int
  programsCount         Int
  tuitionRange          String
  status                InstitutionStatus
  partnership           PartnershipType
  contactEmail          String
  website               String
  logo                  String?
  description           String

  specialties           String[]
  accreditations        String[]
  programs              Program[]

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
}
  
model Program {
  id                   String        @id @default(uuid())
  title                String
  level                StudyLevel
  intake               Intake?       @relation(fields: [intakeId], references: [id], onDelete: Cascade)
  intakeId             String?
  duration             String
  tuitionFee           String
  applicationFee       String
  englishTestScore     String
  subject              Subject?       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subjectId            String?
  scholarship          Boolean
  lastUpdated          DateTime
  applicationDeadline  DateTime
  ucasCode             String?
  englishWaiver        Boolean
  popularityRank       Int
  status               ProgramStatus

  institutionId        String
  institution          Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  applications         Application[]

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([institutionId])
}

model Subject {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  programs  Program[]

  @@map("subjects")
}

model Intake {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  programs  Program[]
  applications Application[]

  @@map("intakes")
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

model Chat {
  id          String        @id @default(uuid())
  studentId   String        
  agentId     String        
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  student     Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  agent       Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@unique([studentId, agentId])
  @@map("chats")
}

model ChatMessage {
  id          String        @id @default(uuid())
  chatId      String
  senderId    String        // User ID (can be student or agent)
  senderRole  UserRole      // STUDENT or AGENT
  content     String        @db.Text
  status      MessageStatus @default(SENT)
  
  // File Attachment Fields
  attachmentUrl   String?
  attachmentType  String?       // MIME type (e.g., 'image/png', 'application/pdf')
  attachmentName  String?       // Original file name
  attachmentSize  Int?          // Size in bytes

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  chat        Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId])
  @@map("chat_messages")
}
 
 model Application {
  id                  String            @id @default(uuid())
  studentId           String
  programId           String
  status              ApplicationStatus @default(SUBMITTED)
  additionalNotes     String?           @db.Text
  preferredIntakeId   String?
  academicYear        String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  student             Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  program             Program           @relation(fields: [programId], references: [id], onDelete: Cascade)
  preferredIntake     Intake?           @relation(fields: [preferredIntakeId], references: [id], onDelete: SetNull)
  @@index([studentId])
  @@index([programId])
  @@map("applications")
}



